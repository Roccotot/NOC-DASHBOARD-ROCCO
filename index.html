<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGRA FILM ‚Äî NOC Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&family=Exo+2:wght@200;300;400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
/* ============================================================
   VARIABILI & RESET
   ============================================================ */
:root {
  --bg:      #060810;
  --panel:   #0d1526;
  --panel2:  #111d35;
  --accent:  #00d4ff;
  --accent2: #0077ff;
  --green:   #00ff88;
  --red:     #ff3355;
  --orange:  #ff8c00;
  --text:    #c8d8f0;
  --text2:   #6a8aaa;
  --border:  rgba(0,212,255,0.15);
  --glow:    0 0 20px rgba(0,212,255,0.3);
}
* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Exo 2', sans-serif;
  display: flex;
  flex-direction: column;
}

/* Grid background */
body::before {
  content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
  background-image:
    linear-gradient(rgba(0,212,255,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,212,255,0.025) 1px, transparent 1px);
  background-size: 40px 40px;
}
/* Scanlines */
body::after {
  content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
  background: repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.07) 2px,rgba(0,0,0,0.07) 4px);
}

/* ============================================================
   HEADER
   ============================================================ */
header {
  position: relative; z-index: 200;
  flex-shrink: 0;
  background: rgba(6,8,16,0.96);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 32px;
}

.logo { display:flex; align-items:center; gap:14px; }
.logo-icon svg { width:34px; height:34px; }
.logo-text {
  font-family:'Rajdhani',sans-serif; font-weight:700; font-size:20px;
  letter-spacing:3px; color:var(--accent); text-transform:uppercase;
}
.logo-sub {
  font-family:'Share Tech Mono',monospace; font-size:10px;
  color:var(--text2); letter-spacing:2px; margin-top:2px;
}

.header-right { display:flex; align-items:center; gap:10px; }

/* View toggle pills */
.view-toggle {
  display:flex;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  margin-right: 4px;
}
.view-btn {
  display:flex; align-items:center; gap:7px;
  padding: 8px 18px;
  font-family:'Rajdhani',sans-serif; font-weight:600; font-size:13px;
  letter-spacing:1.5px; text-transform:uppercase;
  background: none; border:none; color:var(--text2);
  cursor:pointer; transition:all 0.2s;
  border-right: 1px solid var(--border);
}
.view-btn:last-child { border-right:none; }
.view-btn svg { width:14px; height:14px; flex-shrink:0; }
.view-btn:hover { color:var(--text); background:rgba(0,212,255,0.05); }
.view-btn.active {
  background: linear-gradient(135deg, rgba(0,119,255,0.2), rgba(0,212,255,0.15));
  color: var(--accent);
  box-shadow: inset 0 0 12px rgba(0,212,255,0.1);
}

/* VPN widget */
.vpn-widget {
  display:flex; align-items:center; gap:10px;
  background:var(--panel); border:1px solid var(--border);
  border-radius:8px; padding:8px 14px;
}
.vpn-dot {
  width:9px; height:9px; border-radius:50%;
  background:var(--red); box-shadow:0 0 7px var(--red);
  flex-shrink:0; transition:all 0.4s;
}
.vpn-dot.on { background:var(--green); box-shadow:0 0 10px var(--green); animation:pdot 2s infinite; }
@keyframes pdot { 0%,100%{opacity:1} 50%{opacity:0.4} }
.vpn-label { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text2); letter-spacing:1px; }
.vpn-state { font-family:'Share Tech Mono',monospace; font-size:11px; font-weight:700; color:var(--red); transition:color 0.4s; }
.vpn-state.on { color:var(--green); }

.btn-vpn {
  background:linear-gradient(135deg,var(--accent2),var(--accent));
  border:none; border-radius:6px; color:#000;
  font-family:'Rajdhani',sans-serif; font-weight:700; font-size:12px;
  letter-spacing:2px; padding:7px 16px; cursor:pointer;
  text-transform:uppercase; transition:all 0.2s; white-space:nowrap;
}
.btn-vpn:hover { opacity:0.85; }

/* Zabbix btn */
.btn-zabbix {
  display:flex; align-items:center; gap:7px;
  background:var(--panel); border:1px solid var(--border);
  border-radius:8px; padding:8px 14px;
  color:var(--accent); font-family:'Rajdhani',sans-serif;
  font-weight:600; font-size:13px; letter-spacing:2px;
  cursor:pointer; text-transform:uppercase; transition:all 0.25s;
  white-space:nowrap;
}
.btn-zabbix svg { width:15px; height:15px; }
.btn-zabbix:hover { background:var(--panel2); border-color:var(--accent); box-shadow:var(--glow); color:#fff; }

/* ============================================================
   CONTENT WRAPPER
   ============================================================ */
.view { display:none; flex:1; overflow:hidden; position:relative; }
.view.active { display:flex; flex-direction:column; }

/* ============================================================
   DASHBOARD VIEW
   ============================================================ */
#view-dashboard {
  overflow-y: auto;
}
#view-dashboard::-webkit-scrollbar { width:6px; }
#view-dashboard::-webkit-scrollbar-track { background:transparent; }
#view-dashboard::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

.dash-main {
  position:relative; z-index:1;
  padding:28px 32px;
  max-width:1600px; margin:0 auto; width:100%;
}

/* VPN info panel */
.vpn-info {
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; padding:18px 24px; margin-bottom:28px;
  display:grid; grid-template-columns:auto 1fr auto;
  align-items:center; gap:20px; position:relative; overflow:hidden;
  transition:border-color 0.4s;
}
.vpn-info::before {
  content:''; position:absolute; inset:0; pointer-events:none;
  background:linear-gradient(90deg,rgba(0,212,255,0.05),transparent 60%);
}
.vpn-info-icon {
  width:46px; height:46px; border-radius:10px; flex-shrink:0;
  background:linear-gradient(135deg,rgba(0,119,255,0.2),rgba(0,212,255,0.2));
  border:1px solid var(--border);
  display:flex; align-items:center; justify-content:center;
}
.vpn-info-icon svg { width:22px; height:22px; color:var(--accent); }
.vpn-info-title {
  font-family:'Rajdhani',sans-serif; font-weight:700; font-size:14px;
  letter-spacing:2px; color:#fff; text-transform:uppercase; margin-bottom:5px;
}
.vpn-info-row { display:flex; gap:18px; flex-wrap:wrap; }
.vpn-info-item { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--text2); }
.vpn-info-item span { color:var(--accent); margin-left:5px; }
.vpn-big-status { text-align:right; }
.vpn-big-label { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text2); letter-spacing:2px; margin-bottom:4px; }
.vpn-big-value {
  font-family:'Rajdhani',sans-serif; font-size:20px; font-weight:700;
  color:var(--red); letter-spacing:2px; transition:color 0.4s;
  min-height:28px;
}
.vpn-big-value.on { color:var(--green); }
.vpn-check-msg { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text2); margin-top:5px; }

/* Stats */
.stats-row {
  display:grid; grid-template-columns:repeat(4,1fr);
  gap:14px; margin-bottom:28px;
}
.stat-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:10px; padding:18px 22px;
  position:relative; overflow:hidden;
  animation:fadeUp 0.5s ease both;
}
.stat-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg,var(--accent2),var(--accent));
}
.stat-label { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text2); letter-spacing:2px; text-transform:uppercase; margin-bottom:7px; }
.stat-value { font-family:'Rajdhani',sans-serif; font-size:30px; font-weight:700; color:var(--accent); line-height:1; }
.stat-value.g { color:var(--green); }
.stat-value.r { color:var(--red); }

/* Cinema grid */
.cinemas-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(500px,1fr));
  gap:22px;
}
.cinema-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; overflow:hidden;
  animation:fadeUp 0.6s ease both;
  transition:border-color 0.3s, box-shadow 0.3s;
}
.cinema-card:hover { border-color:rgba(0,212,255,0.4); box-shadow:0 8px 32px rgba(0,0,0,0.4),var(--glow); }
.cinema-card:nth-child(1){animation-delay:.05s}.cinema-card:nth-child(2){animation-delay:.1s}
.cinema-card:nth-child(3){animation-delay:.15s}.cinema-card:nth-child(4){animation-delay:.2s}
.cinema-card:nth-child(5){animation-delay:.25s}.cinema-card:nth-child(6){animation-delay:.3s}
.cinema-card:nth-child(7){animation-delay:.35s}

.cinema-hdr {
  background:var(--panel2); padding:14px 18px;
  display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--border);
  cursor:pointer; user-select:none; transition:background 0.15s;
}
.cinema-hdr:hover { background:rgba(17,29,53,0.9); }
.cinema-name-block { display:flex; align-items:center; gap:11px; }
.cinema-ico {
  width:30px; height:30px; border-radius:6px; flex-shrink:0;
  background:linear-gradient(135deg,var(--accent2),var(--accent));
  display:flex; align-items:center; justify-content:center;
}
.cinema-ico svg { width:16px; height:16px; fill:#000; }
.cinema-name { font-family:'Rajdhani',sans-serif; font-weight:700; font-size:15px; letter-spacing:1.5px; color:#fff; text-transform:uppercase; }
.cinema-loc { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--accent); letter-spacing:1px; margin-top:2px; }
.cinema-meta { display:flex; align-items:center; gap:8px; }
.badge {
  background:rgba(0,0,0,0.3); border:1px solid var(--border);
  border-radius:4px; padding:2px 9px;
  font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text2);
}
.badge.ok { border-color:rgba(0,255,136,0.4); color:var(--green); }
.badge.err { border-color:rgba(255,51,85,0.4); color:var(--red); }
.chevron { width:18px; height:18px; color:var(--text2); transition:transform 0.3s; flex-shrink:0; }
.cinema-card.collapsed .chevron { transform:rotate(-90deg); }

.devices-table { max-height:1000px; overflow:hidden; transition:max-height 0.4s cubic-bezier(0.4,0,0.2,1); }
.cinema-card.collapsed .devices-table { max-height:0; }

.device-row {
  display:grid; grid-template-columns:1fr auto auto auto;
  align-items:center; gap:10px; padding:9px 18px;
  border-bottom:1px solid rgba(255,255,255,0.04); transition:background 0.15s;
}
.device-row:last-child { border-bottom:none; }
.device-row:hover { background:rgba(0,212,255,0.04); }
.device-name { font-size:12px; color:var(--text); }
.dev-type { font-family:'Share Tech Mono',monospace; font-size:9px; padding:2px 7px; border-radius:3px; white-space:nowrap; }
.dev-type.projector { color:#a78bfa; border:1px solid rgba(167,139,250,0.3); }
.dev-type.server    { color:#60a5fa; border:1px solid rgba(96,165,250,0.3); }
.dev-ip {
  font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--accent);
  text-decoration:none; border-bottom:1px dashed rgba(0,212,255,0.3);
  white-space:nowrap; transition:all 0.15s;
}
.dev-ip:hover { color:#fff; border-bottom-color:var(--accent); text-shadow:0 0 8px var(--accent); }
.dev-links { display:flex; align-items:center; gap:6px; }
.dev-status { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.dev-status.ok  { background:var(--green); box-shadow:0 0 5px var(--green); }
.dev-status.err { background:var(--red);   box-shadow:0 0 5px var(--red);   animation:blink 1.5s infinite; }
.dev-btn {
  font-family:'Share Tech Mono',monospace; font-size:9px;
  color:var(--accent2); text-decoration:none;
  padding:2px 7px; border:1px solid rgba(0,119,255,0.3);
  border-radius:3px; transition:all 0.2s; white-space:nowrap;
}
.dev-btn:hover { background:rgba(0,119,255,0.15); border-color:var(--accent2); color:#fff; }
.dev-btn.warn { color:var(--orange); border-color:rgba(255,140,0,0.3); }
.dev-btn.warn:hover { background:rgba(255,140,0,0.1); border-color:var(--orange); }

/* Empty state */
.empty-state {
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; padding:80px 24px; text-align:center;
  animation:fadeUp 0.6s ease both;
}
.empty-ico { width:90px; height:90px; margin-bottom:22px; opacity:0.55; animation:float 3s ease-in-out infinite; }
.empty-ico svg { width:100%; height:100%; }
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
.empty-title { font-family:'Rajdhani',sans-serif; font-size:24px; font-weight:700; letter-spacing:3px; color:#fff; text-transform:uppercase; margin-bottom:10px; }
.empty-sub { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--text2); line-height:1.8; letter-spacing:1px; margin-bottom:28px; }
.empty-sub strong { color:var(--accent); }
.btn-load {
  background:linear-gradient(135deg,var(--accent2),var(--accent));
  border:none; border-radius:8px; color:#000;
  font-family:'Rajdhani',sans-serif; font-weight:700; font-size:14px;
  letter-spacing:3px; padding:11px 32px; cursor:pointer;
  text-transform:uppercase; transition:all 0.2s;
  box-shadow:0 4px 20px rgba(0,212,255,0.3);
}
.btn-load:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(0,212,255,0.5); }

/* ============================================================
   MAP VIEW
   ============================================================ */
#view-map { position:relative; }
#map { width:100%; height:100%; z-index:1; }
.leaflet-container { background:#060810 !important; }

/* Stats bar over map */
.map-stats-bar {
  position:absolute; top:16px; left:50%; transform:translateX(-50%);
  z-index:100;
  display:flex; gap:10px;
  background:rgba(13,21,38,0.9); border:1px solid var(--border);
  border-radius:30px; padding:8px 20px; backdrop-filter:blur(12px);
  pointer-events:none;
}
.msb-item { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--text2); letter-spacing:1px; }
.msb-item span { font-weight:700; margin-left:4px; }
.msb-item span.g { color:var(--green); }
.msb-item span.r { color:var(--red); }
.msb-item span.a { color:var(--accent); }
.msb-sep { color:rgba(255,255,255,0.1); font-family:'Share Tech Mono',monospace; font-size:11px; }

/* Map legend */
.map-legend {
  position:absolute; bottom:24px; left:16px; z-index:100;
  background:rgba(13,21,38,0.92); border:1px solid var(--border);
  border-radius:10px; padding:12px 16px; backdrop-filter:blur(12px);
}
.legend-title { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--text2); letter-spacing:2px; text-transform:uppercase; margin-bottom:9px; }
.legend-item { display:flex; align-items:center; gap:8px; font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--text); margin-bottom:5px; }
.legend-item:last-child{margin-bottom:0}
.ldot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }

/* Marker */
.cmarker {
  width:36px; height:36px; border-radius:50% 50% 50% 0;
  transform:rotate(-45deg); border:2px solid;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.cmarker.all-ok   { background:rgba(0,255,136,0.15); border-color:var(--green);  box-shadow:0 0 12px rgba(0,255,136,0.5); }
.cmarker.has-issues { background:rgba(255,140,0,0.15); border-color:var(--orange); box-shadow:0 0 12px rgba(255,140,0,0.5); }
.cmarker.all-down { background:rgba(255,51,85,0.15);  border-color:var(--red);   box-shadow:0 0 12px rgba(255,51,85,0.5); animation:mpulse 1.8s infinite; }
@keyframes mpulse { 0%,100%{box-shadow:0 0 12px rgba(255,51,85,0.5)} 50%{box-shadow:0 0 28px rgba(255,51,85,0.9)} }
.cmarker-inner { transform:rotate(45deg); display:flex; align-items:center; justify-content:center; width:100%; height:100%; font-size:13px; }

/* Leaflet popup */
.leaflet-popup-content-wrapper {
  background:rgba(10,15,26,0.97) !important;
  border:1px solid var(--border) !important;
  border-radius:12px !important;
  box-shadow:0 8px 40px rgba(0,0,0,0.7),var(--glow) !important;
  padding:0 !important; min-width:290px; max-width:360px;
}
.leaflet-popup-tip-container { display:none !important; }
.leaflet-popup-close-button { color:var(--text2) !important; font-size:17px !important; top:10px !important; right:10px !important; }
.leaflet-popup-close-button:hover { color:#fff !important; }
.leaflet-popup-content { margin:0 !important; width:100% !important; }

.popup-hdr {
  padding:12px 14px 10px; border-bottom:1px solid var(--border);
  display:flex; align-items:flex-start; gap:10px;
}
.popup-ico {
  width:32px; height:32px; border-radius:6px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
}
.popup-ico.ok   { background:rgba(0,255,136,0.12); border:1px solid rgba(0,255,136,0.35); }
.popup-ico.warn { background:rgba(255,140,0,0.12);  border:1px solid rgba(255,140,0,0.35); }
.popup-ico.err  { background:rgba(255,51,85,0.12);   border:1px solid rgba(255,51,85,0.35); }
.popup-ico svg { width:16px; height:16px; }
.popup-title { font-family:'Rajdhani',sans-serif; font-weight:700; font-size:14px; letter-spacing:1.5px; color:#fff; text-transform:uppercase; line-height:1.2; }
.popup-loc { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--accent); letter-spacing:1px; margin-top:2px; }
.popup-addr { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--green); letter-spacing:0.5px; margin-top:3px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:240px; }
.popup-badges { display:flex; gap:5px; margin-top:5px; flex-wrap:wrap; }
.pbadge { font-family:'Share Tech Mono',monospace; font-size:9px; border-radius:3px; padding:2px 7px; border:1px solid; }
.pbadge.ok   { color:var(--green);  border-color:rgba(0,255,136,0.4); }
.pbadge.err  { color:var(--red);    border-color:rgba(255,51,85,0.4); }
.pbadge.info { color:var(--accent); border-color:rgba(0,212,255,0.3); }

.popup-devs { padding:4px 0; max-height:240px; overflow-y:auto; }
.popup-devs::-webkit-scrollbar { width:3px; }
.popup-devs::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
.popup-dev-row {
  display:grid; grid-template-columns:7px 1fr auto auto;
  align-items:center; gap:7px; padding:5px 14px; transition:background 0.15s;
}
.popup-dev-row:hover { background:rgba(0,212,255,0.04); }
.pdot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
.pdot.ok  { background:var(--green); box-shadow:0 0 4px var(--green); }
.pdot.err { background:var(--red);   box-shadow:0 0 4px var(--red);   animation:blink 1.5s infinite; }
.pdev-name { font-size:11px; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.pdev-type { font-family:'Share Tech Mono',monospace; font-size:8px; padding:1px 5px; border-radius:2px; white-space:nowrap; }
.pdev-type.projector { color:#a78bfa; border:1px solid rgba(167,139,250,0.3); }
.pdev-type.server    { color:#60a5fa; border:1px solid rgba(96,165,250,0.3); }
.pdev-ip {
  font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--accent);
  text-decoration:none; border-bottom:1px dashed rgba(0,212,255,0.3);
  transition:all 0.15s; white-space:nowrap;
}
.pdev-ip:hover { color:#fff; border-bottom-color:var(--accent); text-shadow:0 0 7px var(--accent); }

.popup-footer { display:flex; gap:7px; padding:9px 14px; border-top:1px solid var(--border); }
.pfooter-btn {
  flex:1; text-align:center; text-decoration:none;
  font-family:'Rajdhani',sans-serif; font-weight:600; font-size:10px;
  letter-spacing:1.5px; text-transform:uppercase;
  padding:6px 0; border-radius:4px; border:1px solid; transition:all 0.2s;
}
.pfooter-btn.zb  { color:var(--accent); border-color:rgba(0,212,255,0.3); }
.pfooter-btn.zb:hover { background:rgba(0,212,255,0.1); border-color:var(--accent); color:#fff; }
.pfooter-btn.pb  { color:var(--orange); border-color:rgba(255,140,0,0.3); }
.pfooter-btn.pb:hover { background:rgba(255,140,0,0.1); border-color:var(--orange); color:#fff; }

.cinema-tooltip .leaflet-tooltip { background:transparent!important; border:none!important; box-shadow:none!important; }

/* ============================================================
   SHARED
   ============================================================ */
@keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
@keyframes blink  { 0%,100%{opacity:1} 50%{opacity:0.15} }
@keyframes spin   { to{transform:rotate(360deg)} }

.loader {
  display:inline-block; width:13px; height:13px;
  border:2px solid rgba(0,212,255,0.2); border-top-color:var(--accent);
  border-radius:50%; animation:spin 0.8s linear infinite;
  vertical-align:middle; margin-right:5px;
}

/* Toast */
.toast {
  position:fixed; bottom:22px; right:22px; z-index:9999;
  background:var(--panel2); border:1px solid var(--border);
  border-radius:8px; padding:12px 18px;
  font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--text);
  opacity:0; transform:translateY(10px); transition:all 0.3s;
  pointer-events:none; max-width:300px;
}
.toast.show { opacity:1; transform:translateY(0); }
.toast-title { color:var(--accent); font-size:10px; letter-spacing:2px; text-transform:uppercase; margin-bottom:3px; }

/* Corner deco */
.corner-tl,.corner-br { position:fixed; width:60px; height:60px; pointer-events:none; z-index:0; opacity:0.3; }
.corner-tl { top:68px; left:0; border-top:1px solid var(--accent); border-left:1px solid var(--accent); }
.corner-br { bottom:0; right:0; border-bottom:1px solid var(--accent); border-right:1px solid var(--accent); }

/* Responsive */
@media(max-width:900px) {
  .dash-main { padding:16px; }
  .stats-row { grid-template-columns:repeat(2,1fr); }
  .cinemas-grid { grid-template-columns:1fr; }
  header { padding:0 16px; }
  .logo-sub { display:none; }
}
@media(max-width:600px) {
  .vpn-info { grid-template-columns:1fr; }
  .vpn-info-row { flex-direction:column; gap:4px; }
  .header-right { gap:6px; }
  .vpn-widget { display:none; }
}
</style>
</head>
<body>

<div class="corner-tl"></div>
<div class="corner-br"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HEADER
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header>
  <div class="logo">
    <div class="logo-icon">
      <svg viewBox="0 0 36 36" fill="none">
        <rect x="2" y="2" width="32" height="32" rx="4" stroke="#00d4ff" stroke-width="1.5"/>
        <circle cx="18" cy="18" r="8" stroke="#00d4ff" stroke-width="1.5"/>
        <circle cx="18" cy="18" r="3" fill="#00d4ff"/>
        <line x1="18" y1="2" x2="18" y2="10" stroke="#00d4ff" stroke-width="1.5"/>
        <line x1="18" y1="26" x2="18" y2="34" stroke="#00d4ff" stroke-width="1.5"/>
        <line x1="2"  y1="18" x2="10" y2="18" stroke="#00d4ff" stroke-width="1.5"/>
        <line x1="26" y1="18" x2="34" y2="18" stroke="#00d4ff" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <div class="logo-text">Sigra Film</div>
      <div class="logo-sub">NOC DASHBOARD di Rocco Totaro ‚Äî V1.1</div>
    </div>
  </div>

  <div class="header-right">

    <!-- VIEW TOGGLE -->
    <div class="view-toggle">
      <button class="view-btn active" id="tab-dash" onclick="switchView('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
        </svg>
        Dashboard
      </button>
      <button class="view-btn" id="tab-map" onclick="switchView('map')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
          <line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/>
        </svg>
        Mappa
      </button>
    </div>

    <!-- ZABBIX -->
    <button class="btn-zabbix" id="btnZabbix" onclick="loadZabbixData()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2"/>
        <path d="M8 21h8M12 17v4"/>
        <circle cx="12" cy="10" r="2"/><path d="M7 10h2M15 10h2"/>
      </svg>
      <span id="btnZabbixLabel">Carica da Zabbix</span>
    </button>

    <!-- VPN WIDGET -->
    <div class="vpn-widget">
      <div class="vpn-dot" id="vpnDot"></div>
      <div>
        <div class="vpn-label">WIREGUARD VPN</div>
        <div class="vpn-state" id="vpnState">DISCONNESSO</div>
      </div>
    </div>

    <button class="btn-vpn" id="btnVpn" onclick="checkVPNStatus()">VERIFICA</button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DASHBOARD VIEW
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view active" id="view-dashboard">
  <div class="dash-main">

    <!-- VPN INFO PANEL -->
    <div class="vpn-info" id="vpnInfoPanel">
      <div class="vpn-info-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 2L4 6v6c0 5.5 3.5 10.7 8 12 4.5-1.3 8-6.5 8-12V6z"/>
          <path d="M9 12l2 2 4-4"/>
        </svg>
      </div>
      <div>
        <div class="vpn-info-title">WireGuard ‚Äî Sigra Film NOC</div>
        <div class="vpn-info-row">
          <div class="vpn-info-item">ENDPOINT <span>91.187.215.2:13001</span></div>
          <div class="vpn-info-item">INDIRIZZO <span>172.31.1.20/24</span></div>
          <div class="vpn-info-item">DNS <span>8.8.8.8</span></div>
          <div class="vpn-info-item">MTU <span>1412</span></div>
          <div class="vpn-info-item">LISTEN <span>51820</span></div>
          <div class="vpn-info-item">PEER KEY <span>677LTbWPy‚Ä¶</span></div>
        </div>
      </div>
      <div class="vpn-big-status">
        <div class="vpn-big-label">Stato VPN</div>
        <div class="vpn-big-value" id="vpnBigValue">
          <span class="loader"></span>
        </div>
        <div class="vpn-check-msg" id="vpnCheckMsg">Verifica in corso...</div>
      </div>
    </div>

    <!-- STATS -->
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Cinema Totali</div><div class="stat-value" id="statCinemas">‚Äî</div></div>
      <div class="stat-card"><div class="stat-label">Dispositivi Totali</div><div class="stat-value" id="statDevices">‚Äî</div></div>
      <div class="stat-card"><div class="stat-label">Online (SNMP ‚úì)</div><div class="stat-value g" id="statOnline">‚Äî</div></div>
      <div class="stat-card"><div class="stat-label">Offline (SNMP ‚úó)</div><div class="stat-value r" id="statOffline">‚Äî</div></div>
    </div>

    <!-- CINEMA GRID (hidden until load) -->
    <div class="cinemas-grid" id="cinemasGrid" style="display:none"></div>

    <!-- EMPTY STATE -->
    <div class="empty-state" id="emptyState">
      <div class="empty-ico">
        <svg viewBox="0 0 64 64" fill="none">
          <rect x="4" y="10" width="56" height="40" rx="4" stroke="#00d4ff" stroke-width="2"/>
          <circle cx="32" cy="30" r="10" stroke="#00d4ff" stroke-width="2"/>
          <circle cx="32" cy="30" r="4" fill="rgba(0,212,255,0.15)" stroke="#00d4ff" stroke-width="2"/>
          <line x1="32" y1="10" x2="32" y2="20" stroke="#00d4ff" stroke-width="2"/>
          <line x1="32" y1="40" x2="32" y2="50" stroke="#00d4ff" stroke-width="2"/>
          <line x1="4"  y1="30" x2="14" y2="30" stroke="#00d4ff" stroke-width="2"/>
          <line x1="50" y1="30" x2="60" y2="30" stroke="#00d4ff" stroke-width="2"/>
          <line x1="22" y1="54" x2="42" y2="54" stroke="#00d4ff" stroke-width="1.5"/>
          <line x1="32" y1="50" x2="32" y2="54" stroke="#00d4ff" stroke-width="1.5"/>
        </svg>
      </div>
      <div class="empty-title">Nessun dato caricato</div>
      <div class="empty-sub">Premi <strong>Carica da Zabbix</strong> per recuperare<br>la lista dei dispositivi monitorati.</div>
      <button class="btn-load" onclick="loadZabbixData()">
        <span id="btnEmptyLabel">Carica da Zabbix</span>
      </button>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAP VIEW
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-map">
  <div id="map"></div>
  <!-- Stats bar -->
  <div class="map-stats-bar">
    <div class="msb-item">CINEMA <span class="a" id="msb-cinemas">7</span></div>
    <div class="msb-sep">|</div>
    <div class="msb-item">DISPOSITIVI <span class="a" id="msb-devices">47</span></div>
    <div class="msb-sep">|</div>
    <div class="msb-item">ONLINE  <span class="g" id="msb-online">‚Äî</span></div>
    <div class="msb-sep">|</div>
    <div class="msb-item">OFFLINE <span class="r" id="msb-offline">‚Äî</span></div>
  </div>
  <!-- Legend -->
  <div class="map-legend">
    <div class="legend-title">Legenda</div>
    <div class="legend-item"><div class="ldot" style="background:var(--green);box-shadow:0 0 6px var(--green)"></div> Tutti online</div>
    <div class="legend-item"><div class="ldot" style="background:var(--orange);box-shadow:0 0 6px var(--orange)"></div> Problemi parziali</div>
    <div class="legend-item"><div class="ldot" style="background:var(--red);box-shadow:0 0 6px var(--red)"></div> Fuori rete</div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="toast-title" id="toastTitle"></div>
  <div id="toastMsg"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
const ZABBIX_BASE = 'http://162.19.84.22';

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CINEMAS = [
  {
    name:'Aurelia Antica', location:'Grosseto', lat:42.7601, lng:11.1521,
    devices:[
      {name:'Sala 1 ‚Äì Proiettore e ICMP', ip:'10.57.91.12', type:'projector', online:true,  hostid:11193},
      {name:'Sala 2 ‚Äì Proiettore e ICMP', ip:'10.57.91.22', type:'projector', online:true,  hostid:11194},
      {name:'Sala 3 ‚Äì Proiettore e ICMP', ip:'10.57.91.32', type:'projector', online:true,  hostid:11195},
      {name:'Sala 4 ‚Äì Proiettore e ICMP', ip:'10.57.91.42', type:'projector', online:true,  hostid:11196},
    ]
  },
  {
    name:'Clev Village', location:'Chiusi (SI)', lat:42.9975, lng:11.9474,
    devices:[
      {name:'Screen 01 ‚Äì Proiettore', ip:'10.56.70.12', type:'projector', online:false, hostid:11228},
      {name:'Screen 01 ‚Äì Server',     ip:'10.56.70.10', type:'server',    online:false, hostid:11234},
      {name:'Screen 02 ‚Äì Proiettore', ip:'10.56.70.22', type:'projector', online:true,  hostid:11229},
      {name:'Screen 02 ‚Äì Server',     ip:'10.56.70.20', type:'server',    online:false, hostid:11235},
      {name:'Screen 03 ‚Äì Proiettore', ip:'10.56.70.32', type:'projector', online:true,  hostid:11230},
      {name:'Screen 03 ‚Äì Server',     ip:'10.56.70.30', type:'server',    online:true,  hostid:11236},
      {name:'Screen 04 ‚Äì Proiettore', ip:'10.56.70.42', type:'projector', online:true,  hostid:11231},
      {name:'Screen 04 ‚Äì Server',     ip:'10.56.70.40', type:'server',    online:true,  hostid:11237},
      {name:'Screen 05 ‚Äì Proiettore', ip:'10.56.70.52', type:'projector', online:true,  hostid:11232},
      {name:'Screen 05 ‚Äì Server',     ip:'10.56.70.50', type:'server',    online:true,  hostid:11238},
      {name:'Screen 06 ‚Äì Proiettore', ip:'10.56.70.62', type:'projector', online:true,  hostid:11233},
      {name:'Screen 06 ‚Äì Server',     ip:'10.56.70.60', type:'server',    online:true,  hostid:11239},
    ]
  },
  {
    name:'Imperiale', location:'Montecatini Terme', lat:43.8845, lng:10.7722,
    devices:[
      {name:'Sala 1 ‚Äì Proiettore',          ip:'10.57.97.12', type:'projector', online:false, hostid:11289},
      {name:'Sala 1 ‚Äì Server IMS3000',      ip:'10.57.97.10', type:'server',    online:false, hostid:11293},
      {name:'Sala 2 ‚Äì Proiettore',          ip:'10.57.97.22', type:'projector', online:false, hostid:11290},
      {name:'Sala 2 ‚Äì Server IMS3000',      ip:'10.57.97.20', type:'server',    online:false, hostid:11294},
      {name:'Sala 3 ‚Äì Proiettore e Server', ip:'10.57.97.32', type:'projector', online:true,  hostid:11291},
      {name:'Sala 4 ‚Äì Proiettore e Server', ip:'10.57.97.42', type:'projector', online:false, hostid:11292},
    ]
  },
  {
    name:'Isola Verde', location:'Pisa', lat:43.7236, lng:10.4017,
    devices:[
      {name:'Screen 01 ‚Äì Proiettore', ip:'10.58.70.12', type:'projector', online:true, hostid:11254},
      {name:'Screen 01 ‚Äì Server',     ip:'10.58.70.10', type:'server',    online:true, hostid:11255},
      {name:'Screen 02 ‚Äì Proiettore', ip:'10.58.70.22', type:'projector', online:true, hostid:11256},
      {name:'Screen 02 ‚Äì Server',     ip:'10.58.70.20', type:'server',    online:true, hostid:11257},
      {name:'Screen 03 ‚Äì Proiettore', ip:'10.58.70.32', type:'projector', online:true, hostid:11258},
      {name:'Screen 03 ‚Äì Server',     ip:'10.58.70.30', type:'server',    online:true, hostid:11259},
    ]
  },
  {
    name:'Multisala Odeon', location:'Pisa', lat:43.7156, lng:10.3997,
    devices:[
      {name:'Sala 1 Venezia ‚Äì Proiettore',  ip:'10.55.76.12', type:'projector', online:true, hostid:11051},
      {name:'Sala 2 Amalfi ‚Äì Proiettore',   ip:'10.55.76.22', type:'projector', online:true, hostid:11052},
      {name:'Sala 3 Pisa ‚Äì Proiettore',     ip:'10.55.76.32', type:'projector', online:true, hostid:11053},
      {name:'Sala 3 Pisa ‚Äì Server IMS3000', ip:'10.55.76.33', type:'server',    online:true, hostid:11056},
      {name:'Sala 4 Genova ‚Äì Proiettore',   ip:'10.55.76.42', type:'projector', online:true, hostid:11054},
      {name:'Sala 5 Kinzica ‚Äì Proiettore',  ip:'10.55.76.52', type:'projector', online:true, hostid:11055},
    ]
  },
  {
    name:'Nuova Aurora', location:'Sansepolcro', lat:43.5704, lng:12.1402,
    devices:[
      {name:'Sala 1 ‚Äì Proiettore Barco', ip:'10.58.78.12', type:'projector', online:true, hostid:11288},
      {name:'Sala 1 ‚Äì Server Doremi',    ip:'10.58.78.10', type:'server',    online:true, hostid:11287},
    ]
  },
  {
    name:'Splendor', location:'Massa', lat:44.0354, lng:10.1395,
    devices:[
      {name:'Screen 01 ‚Äì Proiettore', ip:'10.58.71.12', type:'projector', online:false, hostid:11240},
      {name:'Screen 01 ‚Äì Server',     ip:'10.58.71.10', type:'server',    online:false, hostid:11247},
      {name:'Screen 02 ‚Äì Proiettore', ip:'10.58.71.22', type:'projector', online:false, hostid:11241},
      {name:'Screen 03 ‚Äì Server',     ip:'10.58.71.30', type:'server',    online:false, hostid:11249},
      {name:'Screen 04 ‚Äì Proiettore', ip:'10.58.71.42', type:'projector', online:false, hostid:11243},
      {name:'Screen 05 ‚Äì Proiettore', ip:'10.58.71.52', type:'projector', online:false, hostid:11244},
      {name:'Screen 05 ‚Äì Server',     ip:'10.58.71.50', type:'server',    online:false, hostid:11251},
      {name:'Screen 06 ‚Äì Proiettore', ip:'10.58.71.62', type:'projector', online:false, hostid:11245},
      {name:'Screen 06 ‚Äì Server',     ip:'10.58.71.60', type:'server',    online:false, hostid:11252},
      {name:'Screen 07 ‚Äì Proiettore', ip:'10.58.71.72', type:'projector', online:false, hostid:11246},
      {name:'Screen 07 ‚Äì Server',     ip:'10.58.71.70', type:'server',    online:false, hostid:11253},
    ]
  }
];

// ‚îÄ‚îÄ VIEW SWITCHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mapInit = false;

function switchView(v) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.view-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  document.getElementById('tab-' + (v === 'dashboard' ? 'dash' : 'map')).classList.add('active');
  if (v === 'map' && !mapInit) {
    mapInit = true;
    initMap(); // async ‚Äî i marker appaiono mano a mano
  }
  if (v === 'map' && window._leafletMap) {
    setTimeout(() => window._leafletMap.invalidateSize(), 50);
  }
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _toastTimer = null;
function showToast(title, msg) {
  const t = document.getElementById('toast');
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastMsg').textContent   = msg;
  t.classList.add('show');
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.classList.remove('show'), 4500);
}

// ‚îÄ‚îÄ VPN AUTO-DETECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VPN_PROBES = ['http://10.57.91.12','http://10.56.70.30','http://10.55.76.12'];
let vpnChecking = false;

function probeIP(url, ms) {
  return new Promise(res => {
    const ctrl = new AbortController();
    const t = setTimeout(() => { ctrl.abort(); res(false); }, ms);
    fetch(url, {signal:ctrl.signal, mode:'no-cors', cache:'no-store'})
      .then(()  => { clearTimeout(t); res(true);  })
      .catch(()  => { clearTimeout(t); res(false); });
  });
}

async function checkVPNStatus() {
  if (vpnChecking) return;
  vpnChecking = true;
  const dot   = document.getElementById('vpnDot');
  const state = document.getElementById('vpnState');
  const big   = document.getElementById('vpnBigValue');
  const msg   = document.getElementById('vpnCheckMsg');
  const btn   = document.getElementById('btnVpn');

  btn.disabled = true;
  big.innerHTML = '<span class="loader"></span>';
  msg.textContent = 'Verifica connessione...';

  const results   = await Promise.all(VPN_PROBES.map(ip => probeIP(ip, 3000)));
  const reachable = results.some(r => r);
  vpnChecking = false;
  btn.disabled = false;

  if (reachable) {
    dot.classList.add('on'); state.textContent = 'CONNESSO'; state.classList.add('on');
    big.textContent = 'ONLINE'; big.className = 'vpn-big-value on';
    msg.textContent = 'Rete VPN raggiungibile ‚úì';
    document.getElementById('vpnInfoPanel').style.borderColor = 'rgba(0,255,136,0.3)';
  } else {
    dot.classList.remove('on'); state.textContent = 'DISCONNESSO'; state.classList.remove('on');
    big.textContent = 'OFFLINE'; big.className = 'vpn-big-value';
    msg.textContent = 'Rete VPN non raggiungibile ‚úó';
    document.getElementById('vpnInfoPanel').style.borderColor = 'rgba(255,51,85,0.3)';
  }
  showToast(reachable ? 'VPN ATTIVA' : 'VPN NON RILEVATA',
    reachable ? 'Tunnel WireGuard attivo. Rete interna raggiungibile.'
              : 'Nessun host interno risponde. Controlla WireGuard.');
}

// ‚îÄ‚îÄ ZABBIX LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let dataLoaded = false;

function loadZabbixData() {
  if (dataLoaded) return;
  const lbl1 = document.getElementById('btnZabbixLabel');
  const lbl2 = document.getElementById('btnEmptyLabel');
  lbl1.innerHTML = '<span class="loader"></span>Caricamento...';
  lbl2.innerHTML = '<span class="loader"></span>Caricamento...';

  setTimeout(() => {
    dataLoaded = true;
    buildDashboardCards();
    document.getElementById('emptyState').style.display  = 'none';
    document.getElementById('cinemasGrid').style.display = 'grid';
    lbl1.textContent = '‚úì Dati caricati';
    showToast('ZABBIX SYNC', '47 dispositivi caricati da 7 cinema.');
  }, 1200);
}

// ‚îÄ‚îÄ DASHBOARD CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildDashboardCards() {
  const grid = document.getElementById('cinemasGrid');
  grid.innerHTML = '';
  let totOn = 0, totOff = 0;

  CINEMAS.forEach(cinema => {
    const on  = cinema.devices.filter(d => d.online).length;
    const off = cinema.devices.length - on;
    totOn += on; totOff += off;

    const rows = cinema.devices.map(d => {
      const latUrl  = `${ZABBIX_BASE}/zabbix.php?action=latest.view&hostids%5B0%5D=${d.hostid}&filter_set=1`;
      const probUrl = `${ZABBIX_BASE}/zabbix.php?action=problem.view&hostids%5B0%5D=${d.hostid}&filter_set=1`;
      return `
        <div class="device-row">
          <div class="device-name">${d.name}</div>
          <span class="dev-type ${d.type}">${d.type === 'projector' ? 'PROIETTORE' : 'SERVER'}</span>
          <a class="dev-ip device-ip-link" href="http://${d.ip}" target="_blank">${d.ip}</a>
          <div class="dev-links">
            <div class="dev-status ${d.online ? 'ok' : 'err'}"></div>
            <a class="dev-btn" href="${latUrl}" target="_blank">DATI</a>
            <a class="dev-btn warn" href="${probUrl}" target="_blank">LOG</a>
          </div>
        </div>`;
    }).join('');

    const card = document.createElement('div');
    card.className = 'cinema-card';
    card.innerHTML = `
      <div class="cinema-hdr" onclick="this.closest('.cinema-card').classList.toggle('collapsed')">
        <div class="cinema-name-block">
          <div class="cinema-ico">
            <svg viewBox="0 0 24 24"><path d="M4 3h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm2 4v10h12V7H6zm2 2h3v6H8V9zm5 0h3v6h-3V9z"/></svg>
          </div>
          <div>
            <div class="cinema-name">${cinema.name}</div>
            <div class="cinema-loc">üìç ${cinema.location}</div>
          </div>
        </div>
        <div class="cinema-meta">
          <span class="badge ok">‚úì ${on} online</span>
          ${off > 0 ? `<span class="badge err">‚úó ${off} offline</span>` : ''}
          <span class="badge">${cinema.devices.length} dev</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
      </div>
      <div class="devices-table">${rows}</div>`;
    grid.appendChild(card);
  });

  document.getElementById('statCinemas').textContent = CINEMAS.length;
  document.getElementById('statDevices').textContent = CINEMAS.reduce((s,c)=>s+c.devices.length,0);
  document.getElementById('statOnline').textContent  = totOn;
  document.getElementById('statOffline').textContent = totOff;
}

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function cinemaStatus(c) {
  const on = c.devices.filter(d => d.online).length;
  if (on === c.devices.length) return 'all-ok';
  if (on === 0)                return 'all-down';
  return 'has-issues';
}
function statusColor(s) {
  return s === 'all-ok' ? 'var(--green)' : s === 'all-down' ? 'var(--red)' : 'var(--orange)';
}

function buildPopupHTML(c, address) {
  const on  = c.devices.filter(d => d.online).length;
  const off = c.devices.length - on;
  const st  = cinemaStatus(c);
  const ic  = st === 'all-ok' ? 'ok' : st === 'all-down' ? 'err' : 'warn';
  const col = statusColor(st);
  const addrLine = address
    ? `<div class="popup-addr">üè† ${address}</div>`
    : `<div class="popup-addr" style="color:var(--text2)">üìç ${c.location}</div>`;

  const rows = c.devices.map(d => `
    <div class="popup-dev-row">
      <div class="pdot ${d.online?'ok':'err'}"></div>
      <div class="pdev-name" title="${d.name}">${d.name}</div>
      <span class="pdev-type ${d.type}">${d.type==='projector'?'PROJ':'SRV'}</span>
      <a class="pdev-ip" href="http://${d.ip}" target="_blank">${d.ip}</a>
    </div>`).join('');

  return `
    <div class="popup-hdr">
      <div class="popup-ico ${ic}">
        <svg viewBox="0 0 24 24" fill="${col}">
          <path d="M4 3h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm2 4v10h12V7H6zm2 2h3v6H8V9zm5 0h3v6h-3V9z"/>
        </svg>
      </div>
      <div style="flex:1;min-width:0">
        <div class="popup-title">${c.name}</div>
        ${addrLine}
        <div class="popup-badges">
          <span class="pbadge ok">‚úì ${on} online</span>
          ${off > 0 ? `<span class="pbadge err">‚úó ${off} offline</span>` : ''}
          <span class="pbadge info">${c.devices.length} dispositivi</span>
        </div>
      </div>
    </div>
    <div class="popup-devs">${rows}</div>
    <div class="popup-footer">
      <a class="pfooter-btn zb" href="${ZABBIX_BASE}/zabbix.php?action=host.view" target="_blank">üìä Zabbix Host</a>
      <a class="pfooter-btn pb" href="${ZABBIX_BASE}/zabbix.php?action=problem.view&filter_set=1" target="_blank">‚ö†Ô∏è Problemi</a>
    </div>`;
}

// Geocoding via Nominatim (OpenStreetMap, gratuito, nessuna API key)
// Cerca "Cinema [nome] [citt√†]" ‚Üí fallback solo "[nome] [citt√†]"
async function geocodeCinema(name, location) {
  // Pulisce la citt√† (rimuove eventuali "(SI)" ecc.)
  const city = location.replace(/\s*\(.*?\)/g, '').trim();
  const queries = [
    `Cinema ${name}, ${city}, Italia`,
    `${name}, ${city}, Italia`,
  ];
  for (const q of queries) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, {headers:{'Accept-Language':'it'}});
      const data = await res.json();
      if (data && data[0]) {
        return {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon),
          address: data[0].display_name.split(',').slice(0,3).join(', ')
        };
      }
    } catch(e) { /* continua con il fallback */ }
  }
  return null; // usa le coordinate fisse se geocoding fallisce
}

async function initMap() {
  const map = L.map('map', {
    center:[43.5, 11.0], zoom:8,
    zoomControl:false, attributionControl:false
  });
  window._leafletMap = map;

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    subdomains:'abcd', maxZoom:19
  }).addTo(map);

  L.control.zoom({position:'bottomright'}).addTo(map);

  // Fix tooltip style
  const s = document.createElement('style');
  s.textContent = `.leaflet-tooltip{background:transparent!important;border:none!important;box-shadow:none!important;padding:0!important}`;
  document.head.appendChild(s);

  let totOn = 0, totOff = 0;

  // Per ogni cinema: geocoding dinamico + creazione marker
  // Rate limit Nominatim: 1 req/secondo ‚Üí aspettiamo 1.1s tra le chiamate
  for (let i = 0; i < CINEMAS.length; i++) {
    const c = CINEMAS[i];
    const st  = cinemaStatus(c);
    const col = statusColor(st);
    const on  = c.devices.filter(d => d.online).length;
    totOn  += on;
    totOff += c.devices.length - on;

    // Geocoding ‚Äî aspetta 1.1s tra richieste per rispettare il rate limit di Nominatim
    if (i > 0) await new Promise(r => setTimeout(r, 1100));
    const geo = await geocodeCinema(c.name, c.location);

    const lat = geo ? geo.lat : c.lat;
    const lng = geo ? geo.lng : c.lng;
    const address = geo ? geo.address : null;

    // Aggiorna le coordinate nel dato (per usi futuri nella sessione)
    c._resolvedLat = lat;
    c._resolvedLng = lng;
    c._address = address;

    const icon = L.divIcon({
      html: `<div class="cmarker ${st}"><div class="cmarker-inner">üé¨</div></div>`,
      className:'', iconSize:[36,36], iconAnchor:[18,36], popupAnchor:[0,-42]
    });

    const marker = L.marker([lat, lng], {icon}).addTo(map);

    const popup = L.popup({
      closeButton: false,
      autoClose:   false,
      closeOnClick:false,
      className:   'cinema-popup'
    }).setContent(buildPopupHTML(c, address));

    marker.bindPopup(popup);

    // ‚îÄ‚îÄ Hover apre/chiude con ritardo per permettere di entrare nel popup ‚îÄ‚îÄ
    let closeTimer = null;

    function openPopup()  {
      clearTimeout(closeTimer);
      marker.openPopup();
    }
    function scheduleClose() {
      closeTimer = setTimeout(() => {
        // Chiude solo se il mouse non √® dentro il popup
        marker.closePopup();
      }, 300);
    }

    marker.on('mouseover', openPopup);
    marker.on('mouseout',  scheduleClose);

    // Quando il popup √® aperto, intercetta mouseover/mouseout sul suo elemento
    marker.on('popupopen', function() {
      const el = marker.getPopup().getElement();
      if (!el) return;
      el.addEventListener('mouseenter', () => clearTimeout(closeTimer));
      el.addEventListener('mouseleave', scheduleClose);
    });

    // Tooltip nome cinema (permanente, sopra il marker)
    marker.bindTooltip(
      `<span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:${col};background:rgba(6,8,16,0.92);border:1px solid ${col}40;padding:3px 9px;border-radius:4px;white-space:nowrap">${c.name}</span>`,
      {permanent:true, direction:'top', offset:[0,-38], opacity:1, className:'cinema-tooltip'}
    );
  }

  document.getElementById('msb-online').textContent  = totOn;
  document.getElementById('msb-offline').textContent = totOff;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setTimeout(checkVPNStatus, 800);
setInterval(checkVPNStatus, 30000);
</script>
</body>
</html>
